<html>

<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Condensed:wght@200&display=swap"
        rel="stylesheet">
    <style>
        html,
        body {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
            font-family: 'IBM Plex Sans Condensed';
            color: rgb(241, 243, 244);
            background-color: rgb(16, 16, 20)
        }

        #logo {
            background: rgb(27, 27, 34);
            top: 0.2%;
            left: 0.2%;
            right: 80.2%;
            bottom: 90.6%;
            position: absolute;
            padding: 1em;
        }

        #nav {
            background: rgb(27, 27, 34);
            top: 0.2%;
            left: 20.2%;
            right: 20.2%;
            bottom: 90.6%;
            position: absolute;
            padding: 1em;
        }

        #login {
            background: rgb(27, 27, 34);
            top: 0.2%;
            left: 80.2%;
            right: 0.2%;
            bottom: 90.6%;
            position: absolute;
            padding: 1em;

        }

        #nw {
            background: rgb(27, 27, 34);
            top: 10.2%;
            left: 0.2%;
            right: 47.7%;
            bottom: 45.4%;
            position: absolute;
            padding: 1em;
            
        }

        #mid {
            background: rgb(27, 27, 34);
            top: 10.2%;
            left: 52.7%;
            right: 32.7%;
            bottom: 45.4%;
            position: absolute;
            padding: 1em;
            
        }

        #ne {
            background: rgb(27, 27, 34);
            top: 10.2%;
            left: 67.7%;
            right: 0.2%;
            bottom: 45.4%;
            position: absolute;
            padding: 1em;
            
        }

        #sw {
            background: rgb(27, 27, 34);
            top: 55.4%;
            left: 0.2%;
            right: 82.2%;
            bottom: 0.2%;
            position: absolute;
            padding: 1em;

            font-size: 20px;            
        }

        #sm {
            background: rgb(27, 27, 34);
            top: 55.4%;
            left: 18.2%;
            right: 47.7%;
            bottom: 0.2%;
            position: absolute;
            padding: 1em;
            
        }

        #se {
            background: rgb(27, 27, 34);
            top: 55.4%;
            left: 52.7%;
            right: 0.2%;
            bottom: 0.2%;
            position: absolute;
            padding: 1em;
            
        }

        .error {
            position: absolute;
            z-index: 10;
            bottom: 10%;
            top: 80%;
            left: 40%;
            right: 40%;
            background-color: red;
            pointer-events: none;
            animation: fade 2s;
        }

        @keyframes fade {
            0% {
                opacity: 1;
                bottom: 10%;
                top: 80%;
            }
            100% {
                opacity: 0;
                bottom: 5%;
                top: 85%;
            }
        }

        #JJS,
        #TT,
        #TS {
            width: 100%;
            position: absolute;
        }

        .form-group {
            position: relative;
            margin: 20px 0;
            box-sizing: border-box;
            border: none
        }

        input {
            font-family: inherit;
        }


        .header {
            font-size: 28px;
            vertical-align: top;
        }

        button {
            font-family: inherit;
        }

        span {
            padding-bottom: 50vh;
        }

        label {
            font-size: medium;
            font-weight: bold;
            margin-right: 10%;
        }

        select {
            font-family: inherit;
        }

        input[type=text] {
            border: 1px solid rgb(241, 243, 244);
            border-radius: 4px;
            background-color: transparent;
            color: rgb(241, 243, 244);
            font-size: large;
            width: 100%;
        }
        input[type=password] {
            border: 1px solid rgb(241, 243, 244);
            border-radius: 4px;
            background-color: transparent;
            color: rgb(241, 243, 244);
            font-size: large;
            width: 100%;
        }
        ::-ms-reveal {
            filter: invert(100%);
        }

        #symbol {
            width: 100%;
            font-size: large;
        }

        #submit {
            width: 100%;
            font-size: large;
            background-color: #6fc9f2;
            border-style: none;
            border-radius: 4px;
            font-weight: bold;
            color: rgb(54, 54, 65);
        }

        #ActivePositions,
        #ActiveOrders {
            width: 100%;
            border-collapse: collapse;
        }

        #Tickers {
            width: 100%;
            height: 100%;
            font-size: x-large;
            font-weight: bolder;
            border-collapse: collapse;
        }
        .pricet {
            text-align: right;
        }

        .orderRow:nth-child(even) {
            background-color: rgb(44, 44, 56);
        }

        .pctup {
            color: transparent;  
            text-shadow: 0 0 0 green;
            text-align: left;
            font-size: small;
        }
        .pctdwn {
            text-align: left;
            color: red;
            font-size: small;
        }
        .pctinit {
            color: transparent;  
            text-shadow: 0 0 0 grey;
            text-align: left;
            font-size: small;
        }

        .remove-button {
            background: transparent;
            border: none;
            font-weight: bold;
            color: inherit;
            border-radius: 5%;
        }
        .remove-button:hover {
            background: red;
        }
        .vol,
        .price,
        .symbol,
        .type,
        .order {
            text-align: center;
            align-items:center;
            justify-content:center;
        }

        .hide {
            display: none !important
        }

        img {
            max-width: 100%;
            vertical-align: middle;
            object-fit: contain;
        }

        .subhead {
            padding-bottom: 1vh;
            font-size: medium;
            font-weight: bold;
            color: rgb(81, 81, 94);
        }

        #stats {
            width: 100%;
        }
        #signin {
            height: 50%;
            width: 100%;
            text-align: center;
            vertical-align: middle;
            font-weight: bold;
            font-size: larger;
        }
        #signin:hover {
            color: rgb(198, 219, 231);
        }
        #connection {
            height: 50%;
            width: 100%;
            text-align: center;
            vertical-align: middle;
        }

        #popupbox{
            top: 15%;
            bottom: 40%;
            left: 35%;
            right: 35%;
            position: absolute;
            background: rgb(27, 27, 34); 
            z-index: 9;
            visibility: hidden;
            border-radius: 2%;
            animation: pulse 10s infinite;
        }
        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 0px 0px rgba(111, 201, 242, 0.4), 0 0 0px 0px rgba(111, 201, 242, 0.36);
            }
            50% {
                box-shadow: 0 0 8px 8px rgba(211, 111, 242, 0.4), 0 0 12px 12px rgba(211, 111, 242, 0.36);
            }
        }
        a {
            color: inherit;
            text-decoration: inherit;
        }
        #pop {
            top:0%;
            bottom:10%;
            width:100%;
            vertical-align: middle;
        }
        #x {
            text-align: right;
            padding-top: 5px;
            padding-right: 10px;
            font-weight: bold;
            font-size: large;
        }
        #x:hover {
            color:red;
        }
        #form1 {
            padding: 10%;
        }
        #loginb {
            width: 100%;
            font-size: large;
            background-color: #6fc9f2;
            border-style: none;
            border-radius: 4px;
            font-weight: bold;
            color: rgb(54, 54, 65);
        }

        select {
            background: rgb(44, 44, 56);
            color: inherit;
        }


        #overlay {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background: #000;
            opacity: 0.5;
            z-index: 5;
            visibility: hidden;
        }


    </style>

    <script type="text/javascript">

        function stopRKey(evt) {
            var evt = (evt) ? evt : ((event) ? event : null);
            var node = (evt.target) ? evt.target : ((evt.srcElement) ? evt.srcElement : null);
            if ((evt.keyCode == 13) && (node.type == "text")) { return false; }
        }

        document.onkeypress = stopRKey;

    </script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
    <script src="p5.js"></script>
    <script src=https://cdnjs.cloudflare.com/ajax/libs/mathjs/3.3.0/math.min.js></script>
</head>

<body>
    <div id="overlay"></div>
    <div id="logo">
        <span>
            <a href="https://www.columbia-alpha-partners.com/" target="_blank"><img src="CAP_Logo.png"></img></a>
        </span>
    </div>
    <div id="nav">
        <table id = "stats">
            <tr>
                <th class="header" id="balance">Balance: $10,000.00</th>
                <th class="header" id="available">Available: $10,000.00</th>
                <th class="header" id="volume">Volume: $0.00/min </th>
            </tr>
        </table>
    </div>
    <div id="popupbox">
        <div id="x"><a href="javascript:login('hide');">x</a></div>
        <div id="form1">
        <form id="loginform" onsubmit="return false;">
            <div class="form-group">
                <label>Username:</label>
                <input id="username" name="username" type="text">
            </div>
            <div class="form-group">
                <label>Password:</label>
                <input id="password" name="password" type="password">
            </div>
            <div class="form-group">
                <button type="submit" id="loginb" formmethod="post">Log In</button>
            </div>
        </form>
        </div>
    </div> 
    <div id="login">
        <div id="signin"><a href="javascript:login('show');" id="user">Sign In</a></div>
        <div id="connection">Not Connected üî¥</div>
    </div>
    <div id="nw">
        <select id="chartsel" onchange="change_graph()">
            <option value="JJSc">JJS</option>
            <option value="TTc">TT</option>
            <option value="TSc">TS</option>
            <option value="iTSc">iTS</option>
            <option value="iJJSc">iJJS</option>
            <option value="iTTc">iTT</option>
        </select>
            <div class="chart" id="JJSc"></div>
            <div class="chart hide" id="TTc"></div>
            <div class="chart hide" id="TSc"></div>
            <div class="chart hide" id="iTSc"></div>
            <div class="chart hide" id="iJJSc"></div>
            <div class="chart hide" id="iTTc"></div>
    </div>
    <div id="mid">
        <table id="Tickers" border=1 bordercolor= #6fc9f2 frame=hsides rules=rows>
            <tr>
                <td>TT</td>
                <td class="pricet" id="TTt">50.00</td>
                <td class="pctinit" id="TTp">‚è¥0%</td>
            </tr>
            <tr>
                <td>JJS</td>
                <td class="pricet" id="JJSt">50.00</td>
                <td class="pctinit" id="JJSp">‚è¥0%</td>
            </tr>
            <tr>
                <td>iTS</td>
                <td class="pricet" id="iTSt">50.00</td>
                <td class="pctinit" id="iTSp">‚è¥0%</td>
            </tr>
            <tr>
                <td>iTT</td>
                <td class="pricet" id="iTTt">50.00</td>
                <td class="pctinit" id="iTTp">‚è¥0%</td>
            </tr>
            <tr>
                <td>TS</td>
                <td class="pricet" id="TSt">50.00</td>
                <td class="pctinit" id="TSp">‚è¥0%</td>
            </tr>
            <tr>
                <td>iJJS</td>
                <td class="pricet" id="iJJSt">50.00</td>
                <td class="pctinit" id="iJJSp">‚è¥0%</td>
            </tr>
        </table>
    </div>
    <div id="ne">
        <div class = "subhead">Active Positions</div>
        <table id="ActivePositions">
            <tr>
                <th>Symbol</th>
                <th>Quantity</th>
                <th>Avg. Price</th>
            </tr>
        </table>
    </div>
    <div id="sm">
        <div class = "subhead">Active Orders</div>
        <table id='ActiveOrders'>
            <tr>
                <th>Symbol</th>
                <th>Quantity</th>
                <th>Price</th>
                <th>Type</th>
            </tr>
        </table>
    </div>
    <div id="sw">
        <div class="subhead">Order Form</div>
        <form id="placeorderform">
            <div class="form-group">
                <label>Symbol</label>
                <div>
                    <select id="symbol" name="symbol" class="form-control">
                        <option value="TT">TT</option>
                        <option value="iTT">iTT</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Type</label>
                <div>
                <label>
                    <input type="radio" name="type" id="type-0" value="Buy" checked="checked">
                    Buy
                </label>
                <label>
                    <input type="radio" name="type" id="type-1" value="Sell">
                    Sell
                </label>
                </div>
            </div>

            <div class="form-group">
                <label>Price</label>
                <input id="price" name="price" type="number" placeholder="200">
            </div>

            <div class="form-group">
                <label>Quantity</label>
                <input id="amount" name="amount" type="number" placeholder="500">
            </div>

            <div class="form-group">
                <input formmethod=post type="submit" id="submit" name="submit">
            </div>

        </form>
    </div>
    <div id="se" style="overflow:auto;"></div>

    <script>

        var time = 1;
        var username;
        var password;
        var balance = 10000.00;
        var available = 10000.00;
        var tradevol = 0.00;

        recentPrices = {
            'JJS': [100, 100, 100, 100],
            'TT': [100, 100, 100, 100],
            'TS': [100, 100, 100, 100],
            'iTS': [100, 100, 100, 100],
            'iTT': [100, 100, 100, 100],
            'iJJS': [100, 100, 100, 100]
        }
        
        tickers = {'JJSt': 100, 'TTt': 100, 'TSt': 100, 'iTSt': 100, 'iTTt': 100, 'iJJSt': 100};

        var layout = {
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
        dragmode: 'zoom', 
        margin: {
            r: 30, 
            t: 0, 
            b: 90, 
            l: 0
        }, 
        showlegend: false, 
        xaxis: {
            rangeslider: {visible: false},
            gridcolor: 'rgb(81, 81, 94)', 
            type: 'linear'
        }, 
        yaxis: {
            autorange: true, 
            type: 'linear',
            gridcolor: 'rgb(81, 81, 94)'
        }
        };

        var trace1 = {
        
        x: [], 
        
        close: [], 
        
        decreasing: {line: {color: '#7F7F7F'}}, 
        
        high: [], 
        
        increasing: {line: {color: '#17BECF'}}, 
        
        line: {color: 'rgba(31,119,180,1)'}, 
        
        low: [], 
        
        open: [], 
        
        type: 'candlestick', 
        xaxis: 'x', 
        yaxis: 'y'
        };
        var trace2 = {
        
        x: [], 
        
        close: [], 
        
        decreasing: {line: {color: '#7F7F7F'}}, 
        
        high: [], 
        
        increasing: {line: {color: '#17BECF'}}, 
        
        line: {color: 'rgba(31,119,180,1)'}, 
        
        low: [], 
        
        open: [], 
        
        type: 'candlestick', 
        xaxis: 'x', 
        yaxis: 'y'
        };
        var trace3 = {
        
        x: [], 
        
        close: [], 
        
        decreasing: {line: {color: '#7F7F7F'}}, 
        
        high: [], 
        
        increasing: {line: {color: '#17BECF'}}, 
        
        line: {color: 'rgba(31,119,180,1)'}, 
        
        low: [], 
        
        open: [], 
        
        type: 'candlestick', 
        xaxis: 'x', 
        yaxis: 'y'
        };     
        var trace4 = {
        
        x: [], 
        
        close: [], 
        
        decreasing: {line: {color: '#7F7F7F'}}, 
        
        high: [], 
        
        increasing: {line: {color: '#17BECF'}}, 
        
        line: {color: 'rgba(31,119,180,1)'}, 
        
        low: [], 
        
        open: [], 
        
        type: 'candlestick', 
        xaxis: 'x', 
        yaxis: 'y'
        };
        var trace5 = {
        
        x: [], 
        
        close: [], 
        
        decreasing: {line: {color: '#7F7F7F'}}, 
        
        high: [], 
        
        increasing: {line: {color: '#17BECF'}}, 
        
        line: {color: 'rgba(31,119,180,1)'}, 
        
        low: [], 
        
        open: [], 
        
        type: 'candlestick', 
        xaxis: 'x', 
        yaxis: 'y'
        };
        var trace6 = {
        
        x: [], 
        
        close: [], 
        
        decreasing: {line: {color: '#7F7F7F'}}, 
        
        high: [], 
        
        increasing: {line: {color: '#17BECF'}}, 
        
        line: {color: 'rgba(31,119,180,1)'}, 
        
        low: [], 
        
        open: [], 
        
        type: 'candlestick', 
        xaxis: 'x', 
        yaxis: 'y'
        };

        function updateplots() {
            Plotly.newPlot('JJSc', [trace1], layout);
            Plotly.newPlot('TTc', [trace2], layout);
            Plotly.newPlot('TSc', [trace3], layout);
            Plotly.newPlot('iJJSc', [trace6], layout);
            Plotly.newPlot('iTTc', [trace5], layout);
            Plotly.newPlot('iTSc', [trace4], layout);
        }


        
        function login(showhide) {
            if(showhide == "show") {
                document.getElementById('popupbox').style.visibility="visible";
                document.getElementById('overlay').style.visibility="visible";
            } else {
                document.getElementById('popupbox').style.visibility="hidden";
                document.getElementById('overlay').style.visibility="hidden"; 
            }
        }

        function convertOrder(vol, id, price) {
            let myEle = document.getElementById(id);
            let newvol = parseInt(myEle.getElementsByClassName("vol")[0].textContent) - vol;
            
            if (newvol <= 0) {
                document.getElementById(id).remove();
            } else {
                myEle.getElementsByClassName("vol")[0].textContent = newvol;
            }
            let name = myEle.getElementsByClassName('symbol')[0].textContent;
            let type = myEle.getElementsByClassName('type')[0].textContent;
            if (type == "Buy") {
                tradevol += vol * price;
                addPosition(name, vol, price);
            } else {
                removePosition(name, vol, price);
            }

        }

        function cancelOrder(name, vol, price, type, id) {
            console.log("Removing order with id: ", id)
            document.getElementById(id).remove();
            if (type == "Buy") {
                available += price * vol;
                updatenav();
            }
        }

        function addOrder(name, vol, price, type, id) {
            const itemList = document.getElementById('ActiveOrders');
            
            const item = document.createElement('tr');
            item.className = 'orderRow';
            item.id = id;

            const Asset = document.createElement('td');
            Asset.textContent = name;
            Asset.className = 'symbol';

            const Vol = document.createElement('td');
            Vol.textContent = vol;
            Vol.className = 'vol';

            const Price = document.createElement('td');
            Price.textContent = "$" + price;
            Price.className = 'price';

            const Type = document.createElement('td');
            Type.textContent = type;
            Type.className = 'type';
            
            const ButtonWrapper = document.createElement('td');
            ButtonWrapper.className = 'order';
            const removeButton = document.createElement('button');
            removeButton.className = 'remove-button';

            removeButton.textContent = 'Cancel';
            removeButton.onclick = function (i) {

                const message = {
                    MessageType: "CancelRequest",
                    OrderId: id,
                    TraderId: username,
                    Price: price,
                    Symbol: name,
                    Side: type,
                    Password: Array.from(password),
                }
    
                // console.log(message);
                ws.send(JSON.stringify(
                    message
                ))
                event.preventDefault();

            };


            item.appendChild(Asset);
            item.appendChild(Vol);
            item.appendChild(Price);
            item.appendChild(Type);
            ButtonWrapper.appendChild(removeButton);
            item.appendChild(ButtonWrapper);

            if (type == "Buy") {
                available -= price * vol;
                updatenav();
            }

            itemList.appendChild(item);

            console.log("Appended new order!")

        }

        function errorEnd(event) {
            event.srcElement.remove()
        }

        function removePosition(name, vol, price) {
            balance += (vol * price);
            available += (vol * price);
            updatenav();
            var myEle = document.getElementById(name + "xyz");
            var curvol = parseFloat(myEle.getElementsByClassName('vol')[0].textContent);
            if (curvol - vol <= 0) {
                myEle.remove();
            }
            myEle.getElementsByClassName('vol')[0].textContent = curvol - vol;
        }

        function addPosition(name, vol, price) {
            balance -= (vol * price);
            updatenav();
            var myEle = document.getElementById(name + "xyz");

            if (myEle) {
                var curvol = parseFloat(myEle.getElementsByClassName('vol')[0].textContent);
                var curp = parseFloat(myEle.getElementsByClassName('price')[0].textContent.substring(1));
                var avgp = (curvol * curp + vol * price) / (curvol + vol);
                myEle.getElementsByClassName('vol')[0].textContent = curvol + vol;
                myEle.getElementsByClassName('price')[0].textContent = avgp;
            } else {
                const itemList = document.getElementById('ActivePositions');

                const item = document.createElement('tr');
                item.className = 'orderRow';
                item.id = name + "xyz";

                const Asset = document.createElement('td');
                Asset.textContent = name;
                Asset.className = 'symbol';

                const Vol = document.createElement('td');
                Vol.textContent = vol;
                Vol.className = 'vol';

                const Price = document.createElement('td');
                Price.textContent = "$" + price;
                Price.className = 'price';

                item.appendChild(Asset);
                item.appendChild(Vol);
                item.appendChild(Price);

                itemList.appendChild(item);
            }
        }

        function numberWithCommas(x) {
            return x.toString().replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",");
        }

        function updatenav() {
            const baldisplay = document.getElementById("balance");
            const availdisplay = document.getElementById("available");
            const voldisplay = document.getElementById("volume");
            baldisplay.textContent = "Balance: $" + numberWithCommas(balance.toFixed(2));
            availdisplay.textContent = "Available: $" + numberWithCommas(available.toFixed(2));
            vpm = parseFloat((tradevol / (time / 6.0)).toFixed(2));
            voldisplay.textContent = "Volume: $" + numberWithCommas(vpm.toFixed(2)) + "/min";
        }

        const charts = document.querySelectorAll(".chart");
        function change_graph() {
            charts.forEach(chart => {
                chart.className = "chart hide";
            })
            show = document.getElementById(chartsel.value);
            show.className = "chart";
            updateplots();
        }
        
        const placeorderform = document.getElementById("placeorderform");
        placeorderform.addEventListener("submit", submitOrder);

        const loginform = document.getElementById("loginform");
        loginform.addEventListener("submit", logIn);

        const ovl = document.getElementById('overlay');
        ovl.addEventListener("click", login)

        username = localStorage.getItem("cap_exchange_username")
        password = localStorage.getItem("cap_exchange_password")


        if ((username != null) && (password != null)) {
            // case where user already put in their info and reloaded or something
            console.log("localStorage usable")
            ws = new WebSocket("ws://10.207.51.247:4000/orders/ws", [username])
        }


        function logIn(event) {
            const data = new FormData(loginform);
            username = str(data.get("username"));
            password = str((data.get("password")));            
            login('hide');
            // dont need to worry about security
            document.getElementById("user").textContent = data.get("username");
            localStorage.setItem("cap_exchange_username", username)
            localStorage.setItem("cap_exchange_password", password)
            // super hack-y, but I think this is the simplest way
            // https://stackoverflow.com/questions/4361173/http-headers-in-websockets-client-api
            ws = new WebSocket("ws://10.207.51.247:4000/orders/ws", [username])
            document.getElementById("connection").textContent = "Connected üü¢";
            event.preventDefault;
        }

        function submitOrder(event) {            
            const data = new FormData(placeorderform);
            price = event.target.elements.price.value;
            symbol = event.target.elements.symbol.value;
            
            const message = {
                    MessageType: "OrderRequest",
                    Price: int(price),
                    TraderId: username,
                    OrderType: data.get("type"),
                    Amount: int(data.get("amount")),
                    Password: Array.from(password),
                    Symbol: data.get("symbol"),
                }
            console.log(message);
            ws.send(JSON.stringify(
                message
            ))
            document.getElementById("placeorderform").reset();
            event.preventDefault();
        }

        // todo: maintain pointer to cross
        // format: index is price, number is total amount at price level.
        // gonna change this so just top 10 are shown. Change price labels
        high_buy = 10
        low_sell = 0
        orderbooks = {
            "TT": {
                "scale_factor": 1,
                "depth_chart_buy": [0] * 50,
                "depth_chart_sell": [0] * 50
            },
            "iTT": {
                "scale_factor": 1,
                "depth_chart_buy": [0] * 50,
                "depth_chart_sell": [0] * 50
            },
        }

        canWidth = 0.95 * document.getElementById('se').clientWidth;
        canHeight = document.getElementById('se').clientHeight;
        x_axis_offset = canHeight - 40;
        scale_factor = 10;

        function setup() {
            updateplots();
            textAlign(LEFT, TOP);
            font = 'IBM Plex Sans Condensed';
            textFont(font);
            canvas = createCanvas(canWidth, canHeight);
            canvas.parent('se');
            textSize(20);
            frameRate(60);
            sel = createSelect();
            sel.parent('se')
            sel.position(canWidth - 80, 20);
            for (var key in orderbooks) {
                if (orderbooks.hasOwnProperty(key)) {
                    sel.option(key);
                }
            }
            sel.changed(select_evt);
            // select_evt()
            update_viz(sel.value());
        }


        function update_viz(symbol) {
            textAlign(CENTER, BOTTOM);
            background(27, 27, 34);
            textSize(10);
            textFont(font);
            buy_pointer = high_buy - 1;
            col_width = canWidth / orderbooks[symbol]["depth_chart_buy"].length
            running_buy_interest = 0;
            fill('rgb(0, 255, 0)');
            while (buy_pointer >= 0) {
                fill('rgb(0, 255, 0)');
                running_buy_interest += orderbooks[symbol]["depth_chart_buy"][buy_pointer]
                rect(buy_pointer * col_width, x_axis_offset - running_buy_interest * orderbooks[symbol]["scale_factor"], col_width, running_buy_interest * orderbooks[symbol]["scale_factor"])
                fill('rgb(241, 243, 244)');
                text(buy_pointer, buy_pointer * col_width + col_width / 2, x_axis_offset + 15)
                if (running_buy_interest > 0) {
                    fill('rgb(241, 243, 244)');
                    text(running_buy_interest, buy_pointer * col_width + col_width / 2, x_axis_offset - running_buy_interest * orderbooks[symbol]["scale_factor"])
                    fill('rgb(0, 255, 0)');
                }
                // console.log(buy_pointer * col_width, x_axis_offset, col_width, running_buy_interest * 10);
                buy_pointer -= 1;
            }

            running_sell_interest = 0;
            sell_pointer = low_sell;
            fill('rgb(255, 0, 0)');
            while (sell_pointer < orderbooks[symbol]["depth_chart_sell"].length) {
                running_sell_interest += orderbooks[symbol]["depth_chart_sell"][sell_pointer]
                rect(sell_pointer * col_width, x_axis_offset - running_sell_interest * orderbooks[symbol]["scale_factor"], col_width, running_sell_interest * orderbooks[symbol]["scale_factor"])
                if (running_sell_interest > 0) {
                    fill('rgb(241, 243, 244)');
                    text(running_sell_interest, sell_pointer * col_width + col_width / 2, x_axis_offset - running_sell_interest * orderbooks[symbol]["scale_factor"])
                    fill('rgb(255, 0, 0)');
                }
                // console.log(sell_pointer * col_width, x_axis_offset, col_width, running_buy_interest*10);
                sell_pointer += 1;
            }

            orderbooks[symbol]["scale_factor"] = (canHeight / 2) / math.max(running_buy_interest, running_sell_interest)
            // console.log(running_buy_interest, running_sell_interest)
            // console.log(math.max(running_buy_interest, running_sell_interest))
            // console.log(scale_factor)

            textAlign(LEFT, TOP);
            fill('rgb(241, 243, 244)');
            textSize(20);
            text(symbol, 10, 10)
            textSize(15);
            text("Total Resting Buy Volume: " + running_buy_interest, 10, 30)
            text("Total Resting Sell Volume: " + running_sell_interest, 10, 45)
        }

        function select_evt() {
            update_viz(sel.value())
            update_viz(sel.value())
        }

        function any_fill_evt(packet) {
            symbol = packet["symbol"];
            price = packet["price"];
            tickerID = symbol + 't';
            pctID = symbol + 'p';
            resting_side = packet["resting_side"]
            // update depth chart
            if(resting_side == "Buy") {
                side = "depth_chart_buy"
            } else if (resting_side == "Sell") {
                side = "depth_chart_sell"
            }

            
            orderbooks[symbol][side][price] -= packet["amount"]

            change = (price - tickers[tickerID]) / tickers[tickerID];
            console.log("pctID", pctID)
            pctele = document.getElementById(pctID);
            tickele = document.getElementById(tickerID);
            if (change < 0) {
                change *= -100;
                change = 'üîª' + change.toString() + '%';
                pctele.className = 'pctdwn';
                pctele.textContent = change;
            } else {
                change *= 100;
                change = 'üî∫' + change.toString() + '%';
                pctele.className = 'pctup'
                pctele.textContent = change;
            }
            tickele.textContent = price;
            tickers[tickele] = price;
            recentPrices[symbol].push(price);
            update_viz(symbol)
        }


        function newCandle() {
            for([key, value] of Object.entries(recentPrices)) {
                o = value[0];
                c = value[value.length - 1];
                h = math.max(value);
                l = math.min(value);
                recentPrices[key] = [c];
                var gd = document.getElementById(key + 'c');
                gd.data[0].open.push(o);
                gd.data[0].close.push(c);
                gd.data[0].high.push(h);
                gd.data[0].low.push(l);
                gd.data[0].x.push(time.toString());
            }
            updateplots();
            updatenav();
            time ++;
        }

        start_up_message = true;
        // receive a message from the server
        ws.onmessage = function (evt) {
            console.log("message received!");
            

            data = evt.data;
            const packet_temp = JSON.parse(data);
            

            console.log("message received:", packet_temp);
            msg_type = Object.keys(packet_temp)[0];
            
            // handling the fact message type is specified as a top level key, with other data under it
            const packet = packet_temp[msg_type]
            
            if (start_up_message) {
                setInterval("newCandle()", 10000);
                document.getElementById("connection").textContent = "Connected üü¢";
                start_up_message = false
                // this is the orderbook dump
                // console.log(packet)
                for (var orderbook in packet) {
                    // console.log(orderbook)
                    if (orderbooks.hasOwnProperty(orderbook)) {
                        packet[orderbook]["buy_side_limit_levels"].forEach((x, i) => {
                            console.log(i, x);
                            orderbooks[orderbook]["depth_chart_buy"][i] = parseInt(x["total_volume"])
                        });
                        packet[orderbook]["sell_side_limit_levels"].forEach((x, i) =>
                            orderbooks[orderbook]["depth_chart_sell"][i] = parseInt(x["total_volume"])
                        );
                    }
                }
                update_viz(sel.value());
            // message types declared in api_messages.rs
            } else if (msg_type == "TradeOccurredMessage") {
                any_fill_evt(packet);
            } else if (msg_type == "NewRestingOrderMessage") {

                const price = parseInt(packet["price"])
                const side = packet["side"]
                const order_vol = parseInt(packet["amount"])
                const symbol = packet["symbol"]

                if (packet["side"] == "Buy") {
                    console.log("updating buy side")
                    orderbooks[symbol]["depth_chart_buy"][price] += order_vol
                } else if (packet["side"] == "Sell") {
                    console.log("updating sell side")
                    orderbooks[symbol]["depth_chart_sell"][price] += order_vol
                }
                if (sel.value() == symbol) {
                    update_viz(symbol);
                }
            } else if (msg_type == "CancelOccurredMessage") {

                const price = parseInt(packet["price"])
                const side = packet["side"]
                const order_vol = parseInt(packet["amount"])
                const symbol = packet["symbol"]

                if (packet["side"] == "Buy") {
                    console.log("updating buy side")
                    orderbooks[symbol]["depth_chart_buy"][price] -= order_vol
                } else if (packet["side"] == "Sell") {
                    console.log("updating sell side")
                    orderbooks[symbol]["depth_chart_sell"][price] -= order_vol
                }
                if (sel.value() == symbol) {
                    update_viz(symbol);
                }
            } else if (msg_type == "OrderConfirmMessage") {
                console.log("OrderConfirmMessage received")
                
                const oi = packet["order_info"];
                addOrder(oi["symbol"], oi["amount"], oi["price"], oi["order_type"], oi["order_id"]);
            } else if (msg_type == "OrderFillMessage") {
                convertOrder(packet["amount_filled"], packet["order_id"], packet["price"])
            } else if (msg_type == "CancelConfirmMessage") {
                const oi = packet["order_info"];
                cancelOrder(oi["symbol"], oi["amount"], oi["price"], oi["order_type"], oi["order_id"]);
            } else if (msg_type == "CancelErrorMessage") {
                error = document.createElement('div');
                error.className = 'error';
                error.textContent = "Error Cancelling Order";
                document.body.appendChild(error);
                error.addEventListener("animationend", errorEnd);
            } else if (msg_type == "OrderPlaceErrorMessage") {
                error = document.createElement('div');
                error.className = 'error';
                error.textContent = "Error Placing Order";
                document.body.appendChild(error);
                error.addEventListener("animationend", errorEnd);
            } 
        };

        function windowResized() {
                canWidth = 0.95 * document.getElementById('se').clientWidth;
                canHeight = document.getElementById('se').clientHeight;
                resizeCanvas(canWidth, canHeight);
                update_viz(sel.value());
                updateplots();
        }

        ws.onclose = function () {
            // websocket is closed.
            console.log("WS Conn closed :(")
            document.getElementById("connection").textContent = "Not Connected üî¥";
        };
/*
  //     **** For testing ****

        // receive a message from the server
        function tester(testpacket) {
            console.log("intester")
            const packet_temp = testpacket
            

            console.log("message received:", packet_temp);
            msg_type = Object.keys(packet_temp)[0];
            
            // handling the fact message type is specified as a top level key, with other data under it
            const packet = packet_temp[msg_type]
            
            if (false) {
                document.getElementById("connection").textContent = "Connected üü¢";
                data = evt.data;
                start_up_message = false
                // this is the orderbook dump
                // console.log(packet)
                for (var orderbook in packet) {
                    // console.log(orderbook)
                    if (orderbooks.hasOwnProperty(orderbook)) {
                        packet[orderbook]["buy_side_limit_levels"].forEach((x, i) => {
                            console.log(i, x);
                            orderbooks[orderbook]["depth_chart_buy"][i] = parseInt(x["total_volume"])
                        });
                        packet[orderbook]["sell_side_limit_levels"].forEach((x, i) =>
                            orderbooks[orderbook]["depth_chart_sell"][i] = parseInt(x["total_volume"])
                        );
                    }
                }
                update_viz(sel.value());
            // message types declared in api_messages.rs
            } else if (msg_type == "TradeOccurredMessage") {
                any_fill_evt(packet);
            } else if (msg_type == "NewRestingOrderMessage") {

                const price = parseInt(packet["price"])
                const side = packet["side"]
                const order_vol = parseInt(packet["amount"])
                const symbol = packet["symbol"]

                if (packet["side"] == "Buy") {
                    console.log("updating buy side")
                    orderbooks[symbol]["depth_chart_buy"][price] += order_vol
                } else if (packet["side"] == "Sell") {
                    console.log("updating sell side")
                    orderbooks[symbol]["depth_chart_sell"][price] += order_vol
                }
                if (sel.value() == symbol) {
                    update_viz(symbol);
                }
            } else if (msg_type == "CancelOccurredMessage") {
                
                const price = parseInt(packet["price"])
                const side = packet["side"]
                const order_vol = parseInt(packet["amount"])
                const symbol = packet["symbol"]

                if (packet["side"] == "Buy") {
                    console.log("updating buy side")
                    orderbooks[symbol]["depth_chart_buy"][level] -= order_vol
                } else if (packet["side"] == "Sell") {
                    console.log("updating sell side")
                    orderbooks[symbol]["depth_chart_sell"][level] -= order_vol
                }
                if (sel.value() == symbol) {
                    update_viz(symbol);
                }
            } else if (msg_type == "OrderConfirmMessage") {
                const oi = packet['order_info'];
                addOrder(oi['symbol'], oi['amount'], oi['price'], oi['order_type'], oi['order_id']);
            } else if (msg_type == "OrderFillMessage") {
                //This is gonna cause balanace discrepency between client and server
                //since we don't know the exact execution price
                convertOrder(packet['amount_filled'], packet['order_id'])
            } else if (msg_type == "CancelConfirmMessage") {
                const oi = packet['order_info'];
                cancelOrder(oi['symbol'], oi['amount'], oi['price'], oi['order_type'], oi['order_id']);
            } else if (msg_type == "CancelErrorMessage") {
                error = document.createElement('div');
                error.className = 'error';
                error.textContent = "Error Cancelling Order";
                document.body.appendChild(error);
                error.addEventListener("animationend", errorEnd);
            } else if (msg_type == "OrderPlaceErrorMessage") {
                error = document.createElement('div');
                error.className = 'error';
                error.textContent = "Error Placing Order";
                document.body.appendChild(error);
                error.addEventListener("animationend", errorEnd);
            } 
        };

        function windowResized() {
                canWidth = 0.95 * document.getElementById('se').clientWidth;
                canHeight = document.getElementById('se').clientHeight;
                resizeCanvas(canWidth, canHeight);
                update_viz("JJS");
                updateplots();
        }

        ws.onclose = function () {
            // websocket is closed.
            console.log("WS Conn closed :(")
            document.getElementById("connection").textContent = "Not Connected üî¥";
        };
        
        

        var orderconfirm = {
            'OrderConfirmMessage': {
                'order_info': {
                    'order_id': '12345',
                    'trader_id': 'TraderId',
                    'symbol': 'JJS',
                    'amount': 500,
                    'price': 500,
                    'order_type': 'Buy',
                }
            }
        }

        var orderconvert = {
            'OrderFillMessage' : {
                'order_id': '12345',
                'amount_filled': 200
            }
        }

        var orderconvert2 = {
            'OrderFillMessage' : {
                'order_id': '12345',
                'amount_filled': 300
            }
        }

        var errortest = {
            "CancelErrorMessage" : {}
        }

        var sell1 = {
            'OrderConfirmMessage': {
                'order_info': {
                    'order_id': '123',
                    'trader_id': 'TraderId',
                    'symbol': 'JJS',
                    'amount': 500,
                    'price': 500,
                    'order_type': 'Sell',
                }
            }
        }

        var sell2 = {
            "OrderFillMessage" : {
                "order_id" : '123',
                "amount_filled" : '300'
            }
        }

        var sell3 = {
            "OrderFillMessage" : {
                "order_id" : '123',
                "amount_filled" : '200'
            }
        }

        var ordercancel = {
            "CancelConfirmMessage" : {
                'order_info': {
                    'order_id': '123',
                    'trader_id': 'TraderId',
                    'symbol': 'JJS',
                    'amount': 500,
                    'price': 500,
                    'order_type': 'Sell',
                }
            }
        }


        tester(orderconvert);
        tester(errortest);
        tester(orderconvert2);
        tester(sell1);
        tester(ordercancel);

*/
    </script>
</body>
</html>